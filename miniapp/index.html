<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>LGW33 - é¦–é¡µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      /* é»‘è‰²åˆ°é»„è‰²æ¸å˜ä¸»é¢˜ */
      --bg-primary: #000000;
      --bg-gradient-start: #000000;
      --bg-gradient-end: #FFC107;
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border: rgba(255, 193, 7, 0.3);
      --accent-blue: #2196F3;
      --accent-blue-light: #64B5F6;
      --accent-yellow: #FFC107;
      --accent-orange: #FF9800;
      --text-primary: #FFFFFF;
      --text-secondary: #E0E0E0;
      --text-muted: #BDBDBD;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Noto Sans CJK SC", Arial, sans-serif;
      color: var(--text-primary);
      background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
    }
    /* å®‰å…¨åŒºåŸŸå®¹å™¨ */
    .safe{
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      max-width: 430px;
      margin: 0 auto;
      position: relative;
      min-height: 100vh;
    }
    /* é¡¶éƒ¨æ  */
    .topbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 2px 8px 2px;
      gap: 12px;
      position: relative;
    }
    /* å·¦ä¾§ç”¨æˆ·ä¿¡æ¯ */
    .user{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      flex: 1;
    }
    .avatar{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(33,150,243,0.2), rgba(33,150,243,0.1));
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-sm);
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
    }
    .avatar::after{
      content: "";
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent 60%);
      transform: rotate(18deg);
    }
    .avatar span{
      position: relative;
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: 14px;
      color: var(--accent-blue);
    }
    .namewrap{ min-width: 0; }
    .name{
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }
    .sub{
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }
    /* ä¸­é—´å“ç‰ŒLogo */
    .brandTitle{
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .brandTitle .logo{
      display: flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      pointer-events: auto;
    }
    .brandTitle .logo img{
      height: 100%;
      width: auto;
      display: block;
      vertical-align: middle;
    }
    /* Tokenæ•°å­—åŒºåŸŸ */
    .hero{
      margin-top: 6px;
      padding: 10px 0 0;
    }
    .tokenRow{
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 6px;
    }
    .coin{
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .coin img{
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .token{
      font-size: 42px;
      font-weight: 1000;
      letter-spacing: 0.5px;
      line-height: 1;
      color: var(--text-primary);
      text-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* ä¸»èˆå° */
    .stage{
      margin-top: 12px;
      position: relative;
      padding: 16px 14px 70px 14px;
    }
    /* ä¸­å¤®å‰ç¥¥ç‰© */
    .mascot{
      margin: 10px auto 0;
      width: 240px;
      aspect-ratio: 3/4;
      display: grid;
      place-items: center;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .mascot:active{ transform: scale(0.98); }
    .mascot::before{
      content: "LGW33\nMASCOT";
      white-space: pre;
      text-align: center;
      font-weight: 1000;
      letter-spacing: 1px;
      line-height: 1.15;
      font-size: 20px;
      color: var(--text-primary);
    }
    .mascot small{
      position: absolute;
      bottom: 14px;
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 600;
    }
    .mascot-image{
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2));
    }
    .mascot.has-image::before{ display: none; }
    .mascot.has-image small{ display: none; }
    /* åº•éƒ¨å¯¼èˆª */
    .nav{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      width: calc(100% - 56px);
      max-width: 374px;
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.1);
      background: var(--accent-yellow);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-around;
      box-shadow: var(--shadow-md);
      z-index: 100;
    }
    .nav .item{
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 16px;
      color: #FFFFFF;
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      text-decoration: none;
      transition: all 0.2s;
    }
    .nav .item.active{
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(0,0,0,0.1);
      color: #FFFFFF;
    }
    .nav .item:hover{ background: rgba(0,0,0,0.1); }
    .nav .i{
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    /* åŠ è½½çŠ¶æ€ */
    .loading{
      display: inline-block;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{ opacity: 0.5; }
      50%{ opacity: 1; }
    }
    /* å…¨å±Loadingå±‚ */
    .loading-overlay{
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s ease-out;
    }
    .loading-overlay.hidden{
      opacity: 0;
      pointer-events: none;
    }
    .loading-spinner{
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255,193,7,0.2);
      border-top-color: var(--accent-yellow);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{
      to{ transform: rotate(360deg); }
    }
    .loading-text{
      margin-top: 16px;
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 600;
    }
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 375px){
      .mascot{ width: 200px; }
      .token{ font-size: 36px; }
    }
    @media (min-width: 768px){
      .mascot{ width: 280px; }
    }
  </style>
</head>
<body>
  <!-- å…¨å±Loadingå±‚ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">åŠ è½½ä¸­...</div>
  </div>

  <div class="safe">
    <!-- é¡¶éƒ¨æ  -->
    <div class="topbar">
      <!-- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯ -->
      <div class="user">
        <div class="avatar"><span id="avatarText">LG</span></div>
        <div class="namewrap">
          <div class="name" id="userName">ç©å®¶</div>
          <div class="sub">
            <span id="userStatus">åœ¨çº¿</span>
          </div>
        </div>
      </div>
      <!-- ä¸­é—´ï¼šå“ç‰ŒLogo -->
      <div class="brandTitle">
        <span class="logo">
          <img src="image/logo.png" alt="LGW33" onerror="this.parentElement.innerHTML='<span style=font-weight:900;font-size:20px;color:#FFC107>LGW33</span>'">
        </span>
      </div>
    </div>

    <!-- Tokenæ•°å­—åŒºåŸŸ -->
    <section class="hero">
      <div class="tokenRow">
        <div class="coin" aria-hidden="true">
          <img src="image/token.png" alt="Token" onerror="this.parentElement.innerHTML='ğŸª™'">
        </div>
        <div class="token" id="tokenNum"><span class="loading">--</span></div>
      </div>
    </section>

    <!-- ä¸»èˆå° -->
    <section class="stage">
      <!-- ä¸­å¤®å‰ç¥¥ç‰© -->
      <div class="mascot has-image" id="mascot">
        <img src="image/å‰ç¥¥ç‰©.png" alt="LGW33 å‰ç¥¥ç‰©" class="mascot-image" id="mascotImage">
      </div>

      <!-- åº•éƒ¨å¯¼èˆª -->
      <div class="nav" role="navigation" aria-label="bottom nav">
        <a href="#" class="item active" data-tab="home">
          <span class="i">ğŸ </span> Home
        </a>
        <a href="pk.html" class="item" data-tab="games">
          <span class="i">ğŸ®</span> PK
        </a>
      </div>
    </section>
  </div>
<script>
  // ==================== é…ç½® ====================
  // è‡ªåŠ¨æ£€æµ‹APIåœ°å€
  const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? "http://127.0.0.1:8000"
    : window.location.origin;

  // ==================== Telegram WebApp åˆå§‹åŒ– ====================
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // è·å–ç”¨æˆ·ä¿¡æ¯å¹¶æ˜¾ç¤º
    const user = tg.initDataUnsafe?.user;
    if (user) {
      const userName = user.first_name || user.username || 'ç©å®¶';
      document.getElementById('userName').textContent = userName;
      // è®¾ç½®å¤´åƒæ–‡å­—
      const initials = userName.substring(0, 2).toUpperCase();
      document.getElementById('avatarText').textContent = initials;
    }
  }

  // ==================== è·å–ç”¨æˆ·ä¿¡æ¯ ====================
  function getUser() {
    if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
      const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
      return {
        user_id: tgUser.id,
        username: tgUser.username || tgUser.first_name || null
      };
    }
    // æœ¬åœ°è°ƒè¯•é»˜è®¤å€¼
    return { user_id: 12345, username: 'player1' };
  }

  // ==================== Tokenä½™é¢ç®¡ç† ====================
  function updateToken(amount) {
    const tokenEl = document.getElementById('tokenNum');
    tokenEl.textContent = amount.toLocaleString('zh-CN');
  }

  async function loadBalance() {
    try {
      const u = getUser();
      const r = await fetch(`${API}/api/users/${u.user_id}`);
      if (r.ok) {
        const data = await r.json();
        updateToken(data.available);
        // ç¼“å­˜åˆ°localStorage
        localStorage.setItem('lgw33_balance', data.available);
      } else {
        // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé»˜è®¤ä½™é¢
        updateToken(1000);
      }
    } catch (e) {
      console.error("è·å–ä½™é¢å¤±è´¥:", e);
      // å°è¯•ä»ç¼“å­˜è¯»å–
      const savedBalance = localStorage.getItem('lgw33_balance');
      if (savedBalance) {
        updateToken(parseInt(savedBalance));
      } else {
        updateToken(1000);
      }
    }
  }

  // ==================== å¯¼èˆªäº¤äº’ ====================
  document.querySelectorAll('.nav .item').forEach(item => {
    item.addEventListener('click', function(e) {
      // Telegramè§¦è§‰åé¦ˆ
      if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
      }
      // æ›´æ–°æ¿€æ´»çŠ¶æ€
      document.querySelectorAll('.nav .item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
    });
  });

  // ==================== å‰ç¥¥ç‰©ç‚¹å‡»äº¤äº’ ====================
  document.getElementById('mascot')?.addEventListener('click', () => {
    if (window.Telegram?.WebApp?.HapticFeedback) {
      window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
    // ç®€å•çš„å¼¹è·³åŠ¨ç”»
    const mascot = document.getElementById('mascot');
    mascot.style.transform = 'scale(0.95)';
    setTimeout(() => mascot.style.transform = '', 150);
  });

  // ==================== ç¾æœ¯èµ„æºåŠ è½½ ====================
  const mascotImage = document.getElementById('mascotImage');
  const mascot = document.getElementById('mascot');

  if (mascotImage) {
    mascotImage.onerror = function() {
      console.warn('å‰ç¥¥ç‰©å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦');
      mascot.classList.remove('has-image');
    };
  }

  // ==================== å›¾ç‰‡é¢„åŠ è½½ + éšè—Loadingå±‚ ====================
  function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.classList.add('hidden');
      // åŠ¨ç”»ç»“æŸåç§»é™¤DOMèŠ‚çœèµ„æº
      setTimeout(() => overlay.remove(), 300);
    }
  }

  function preloadImages(urls) {
    // è¿”å›Promiseï¼Œç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼ˆæˆåŠŸæˆ–å¤±è´¥éƒ½ç®—å®Œæˆï¼‰
    return Promise.all(urls.map(url => {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = resolve;
        img.onerror = resolve; // å¤±è´¥ä¹Ÿç»§ç»­ï¼Œä¸é˜»å¡
        img.src = url;
      });
    }));
  }

  // ==================== åˆå§‹åŒ– ====================
  document.addEventListener('DOMContentLoaded', async () => {
    // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæœ‰room_idåˆ™è·³è½¬åˆ°PKé¡µé¢
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room_id');
    if (roomId) {
      window.location.href = `pk.html?room_id=${roomId}`;
      return;
    }

    // é¢„åŠ è½½é¦–å±å…³é”®å›¾ç‰‡
    const imagesToPreload = [
      'image/logo.png',
      'image/token.png',
      'image/å‰ç¥¥ç‰©.png'
    ];

    // è¶…æ—¶ä¿æŠ¤ï¼šæœ€å¤šç­‰3ç§’
    const timeout = new Promise(resolve => setTimeout(resolve, 3000));

    try {
      // å¹¶è¡Œï¼šé¢„åŠ è½½å›¾ç‰‡ + åŠ è½½ä½™é¢ï¼Œä½†æœ€å¤šç­‰3ç§’
      await Promise.race([
        Promise.all([
          preloadImages(imagesToPreload),
          loadBalance()
        ]),
        timeout
      ]);
    } catch (e) {
      console.error('åŠ è½½å‡ºé”™:', e);
    }

    // æ— è®ºæˆåŠŸå¤±è´¥éƒ½éšè—Loadingå±‚
    hideLoading();
  });
</script>
</body>
</html>
