<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LGW33 PK - 1win Style</title>
  <style>
    :root{
      --bg-primary: #0A1628;
      --bg-secondary: #1A2B4A;
      --bg-card: rgba(26, 43, 74, 0.6);
      --accent-blue: #00D4FF;
      --accent-yellow: #FFD700;
      --accent-green: #00FF88;
      --accent-red: #FF4757;
      --text-primary: #FFFFFF;
      --text-secondary: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      --radius-md: 18px;
      --radius-lg: 24px;
      --shadow-md: 0 8px 24px rgba(0,0,0,0.4);
      --shadow-lg: 0 16px 48px rgba(0,0,0,0.5);
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      background:
        radial-gradient(circle at 50% 0%, rgba(0,212,255,0.15), transparent 50%),
        radial-gradient(circle at 0% 100%, rgba(255,215,0,0.1), transparent 50%),
        linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", Arial, sans-serif;
      overflow-x: hidden;
      position: relative;
    }
    .bg-decoration{
      position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;
    }
    .bg-circle{
      position: absolute; border-radius: 50%;
      background: radial-gradient(circle, rgba(0,212,255,0.2), transparent 70%);
      animation: float 20s ease-in-out infinite;
    }
    .bg-circle:nth-child(1){ width:300px; height:300px; top:-100px; left:-100px; }
    .bg-circle:nth-child(2){ width:400px; height:400px; bottom:-150px; right:-150px; animation-delay: 5s; }
    @keyframes float{
      0%, 100%{ transform: translate(0, 0) scale(1); opacity: 0.3; }
      50%{ transform: translate(30px, -30px) scale(1.1); opacity: 0.5; }
    }
    .app-container{
      position: relative; z-index: 1; min-height: 100vh;
      max-width: 480px; margin: 0 auto;
      padding: env(safe-area-inset-top, 16px) 16px env(safe-area-inset-bottom, 16px);
      display: flex; flex-direction: column; gap: 16px;
    }
    .top-bar{
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .balance-card{
      flex: 1; background: var(--bg-card); backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-lg);
      padding: 12px 16px; display: flex; align-items: center; gap: 10px;
      box-shadow: var(--shadow-md);
    }
    .coin-icon{
      width: 36px; height: 36px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-yellow), #FFA500);
      display: flex; align-items: center; justify-content: center; font-size: 20px;
      box-shadow: 0 4px 12px rgba(255,215,0,0.4);
    }
    .balance-info{ flex: 1; }
    .balance-label{
      font-size: 11px; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .balance-amount{
      font-size: 20px; font-weight: 900; color: var(--accent-yellow);
      font-variant-numeric: tabular-nums;
    }
    .menu-btn{
      width: 44px; height: 44px; background: var(--bg-card);
      backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md); display: flex; align-items: center;
      justify-content: center; cursor: pointer; transition: all 0.2s;
      box-shadow: var(--shadow-md); font-size: 20px;
    }
    .menu-btn:active{ transform: scale(0.95); }
    .card-1win{
      background: var(--bg-card); backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-lg);
      padding: 20px; box-shadow: var(--shadow-lg); position: relative; overflow: hidden;
    }
    .card-1win::before{
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
      animation: shimmer 3s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%, 100%{ opacity: 0.3; }
      50%{ opacity: 1; }
    }
    .card-title{
      font-size: 14px; font-weight: 700; color: var(--text-secondary);
      margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .input-group{
      display: flex; gap: 10px; margin-bottom: 12px;
    }
    .input-1win{
      flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 12px 14px; color: var(--text-primary);
      font-size: 14px; outline: none; transition: all 0.2s;
    }
    .input-1win::placeholder{ color: var(--text-muted); }
    .input-1win:focus{
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
    }
    .btn-1win{
      width: 100%; padding: 14px; border: none; border-radius: 12px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      color: var(--text-primary); font-size: 15px; font-weight: 700;
      cursor: pointer; box-shadow: 0 8px 24px rgba(0,212,255,0.3);
      transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .btn-1win:active{ transform: scale(0.98); }
    .btn-1win:disabled{
      opacity: 0.5; cursor: not-allowed;
    }
    .btn-secondary{
      background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2);
      box-shadow: none;
    }
    .info-text{
      font-size: 13px; color: var(--text-secondary);
      padding: 10px; background: rgba(0,0,0,0.2);
      border-radius: 8px; margin-top: 10px; line-height: 1.5;
    }
    .debug-section{
      background: rgba(255,215,0,0.05); border: 1px dashed rgba(255,215,0,0.3);
    }
    .vs-card{
      display: grid; grid-template-columns: 1fr auto 1fr;
      gap: 16px; align-items: center; margin-bottom: 16px;
    }
    .player-card{
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .avatar-3d{
      width: 64px; height: 64px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      border: 3px solid rgba(255,255,255,0.2);
      box-shadow: 0 8px 24px rgba(0,212,255,0.3), inset 0 2px 8px rgba(255,255,255,0.3);
      position: relative; overflow: hidden;
    }
    .avatar-3d::before{
      content: ''; position: absolute; top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent 50%);
      animation: rotate 10s linear infinite;
    }
    @keyframes rotate{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }
    .avatar-3d.opponent{
      background: linear-gradient(135deg, var(--accent-red), var(--accent-yellow));
      box-shadow: 0 8px 24px rgba(255,71,87,0.3), inset 0 2px 8px rgba(255,255,255,0.3);
    }
    .player-name{
      font-size: 14px; font-weight: 700; color: var(--text-primary);
    }
    .player-status{
      font-size: 11px; color: var(--text-muted);
    }
    .vs-divider{
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .vs-text{
      font-size: 16px; font-weight: 900; color: var(--text-secondary);
      letter-spacing: 2px;
    }
    .timer-display{
      font-size: 24px; font-weight: 900; color: var(--accent-yellow);
      font-variant-numeric: tabular-nums;
      text-shadow: 0 0 20px rgba(255,215,0,0.5);
      min-width: 70px; text-align: center;
    }
    .scores-grid{
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    }
    .score-box{
      background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md); padding: 16px; text-align: center;
      position: relative; overflow: hidden; transition: all 0.3s;
    }
    .score-box.winning{
      border-color: var(--accent-green);
      box-shadow: 0 0 20px rgba(0,255,136,0.3);
    }
    .score-box.winning::before{
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg, transparent, rgba(0,255,136,0.1));
    }
    .score-label{
      font-size: 11px; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
    }
    .score-value{
      font-size: 36px; font-weight: 900; color: var(--text-primary);
      font-variant-numeric: tabular-nums; line-height: 1;
    }
    .score-value.pulse{
      animation: scorePulse 0.3s ease-out;
    }
    @keyframes scorePulse{
      0%{ transform: scale(1); }
      50%{ transform: scale(1.15); color: var(--accent-yellow); }
      100%{ transform: scale(1); }
    }
    .tap-zone{
      display: flex; align-items: center; justify-content: center;
      position: relative; min-height: 280px; margin: 20px 0;
    }
    .tap-button-3d{
      width: min(280px, 75vw); height: min(280px, 75vw);
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2), transparent 50%),
        radial-gradient(circle at 50% 50%, var(--accent-blue), var(--accent-green));
      border: 4px solid rgba(255,255,255,0.3);
      box-shadow:
        0 20px 60px rgba(0,212,255,0.4),
        0 0 80px rgba(0,255,136,0.3),
        inset 0 -10px 30px rgba(0,0,0,0.3),
        inset 0 10px 30px rgba(255,255,255,0.2);
      cursor: pointer; user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.1s; position: relative;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 12px;
    }
    .tap-button-3d::before{
      content: ''; position: absolute; inset: -20px; border-radius: 50%;
      background: radial-gradient(circle, var(--accent-blue), transparent 60%);
      opacity: 0.5; animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{ transform: scale(0.9); opacity: 0.3; }
      50%{ transform: scale(1.1); opacity: 0.6; }
    }
    .tap-button-3d:active{
      transform: scale(0.95);
      box-shadow:
        0 10px 30px rgba(0,212,255,0.5),
        0 0 60px rgba(0,255,136,0.4),
        inset 0 -5px 20px rgba(0,0,0,0.4);
    }
    .tap-icon{
      font-size: 64px; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
      position: relative; z-index: 1;
    }
    .tap-text{
      font-size: 18px; font-weight: 900; color: var(--text-primary);
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
      position: relative; z-index: 1; letter-spacing: 1px;
    }
    .tap-hint{
      font-size: 12px; color: rgba(255,255,255,0.8);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      position: relative; z-index: 1;
    }
    .float-score{
      position: absolute; font-size: 32px; font-weight: 900;
      color: var(--accent-yellow);
      text-shadow: 0 0 20px rgba(255,215,0,0.8);
      pointer-events: none;
      animation: floatUp 0.8s ease-out forwards;
      z-index: 100;
    }
    @keyframes floatUp{
      0%{ transform: translate(-50%, 0) scale(0.5); opacity: 0; }
      20%{ opacity: 1; }
      100%{ transform: translate(-50%, -100px) scale(1.2); opacity: 0; }
    }
    .status-indicator{
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-radius: 999px;
      background: rgba(0,0,0,0.3); font-size: 11px; font-weight: 600;
    }
    .status-dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--accent-green);
      box-shadow: 0 0 12px var(--accent-green);
      animation: blink 2s ease-in-out infinite;
    }
    @keyframes blink{
      0%, 100%{ opacity: 1; }
      50%{ opacity: 0.3; }
    }
    .ready-section{
      display: flex; gap: 12px; margin-top: 16px;
    }
    .result-card{
      text-align: center; padding: 20px;
      background: rgba(0,0,0,0.3); border-radius: var(--radius-md);
      margin-top: 16px;
    }
    .result-emoji{
      font-size: 64px; margin-bottom: 16px;
    }
    .result-text{
      font-size: 18px; font-weight: 700; margin-bottom: 12px;
    }
    .result-details{
      font-size: 14px; color: var(--text-secondary); line-height: 1.8;
    }
  </style>
</head>
<body>
  <div class="bg-decoration">
    <div class="bg-circle"></div>
    <div class="bg-circle"></div>
  </div>

  <div class="app-container">
    <!-- é¡¶éƒ¨æ  -->
    <div class="top-bar">
      <div class="balance-card">
        <div class="coin-icon">ğŸª™</div>
        <div class="balance-info">
          <div class="balance-label">LGW33 ä½™é¢</div>
          <div class="balance-amount" id="balance">--</div>
        </div>
      </div>
      <button class="menu-btn" onclick="toggleDebug()">âš™ï¸</button>
    </div>

    <!-- DebugåŒºåŸŸï¼ˆå¯æŠ˜å ï¼‰ -->
    <div class="card-1win debug-section" id="debugSection" style="display:none;">
      <div class="card-title">ğŸ”§ è°ƒè¯•æ¨¡å¼</div>
      <div class="input-group">
        <input class="input-1win" id="uid" placeholder="user_id (ä¾‹å¦‚: 12345)" />
        <input class="input-1win" id="uname" placeholder="username (ä¾‹å¦‚: yangtae)" />
      </div>
      <button class="btn-1win btn-secondary" onclick="checkBalance()">æŸ¥è¯¢ä½™é¢</button>
      <div class="info-text" id="balanceInfo" style="display:none;"></div>
    </div>

    <!-- åˆ›å»ºæˆ¿é—´åŒºåŸŸ -->
    <div class="card-1win" id="createSection">
      <div class="card-title">ğŸ® åˆ›å»ºæ–°æˆ¿é—´</div>
      <input class="input-1win" id="bet" placeholder="æŠ¼æ³¨é‡‘é¢ (1-100000 LGW33)" type="number" />
      <button class="btn-1win" onclick="createRoom()">åˆ›å»ºæˆ¿é—´å¹¶é‚€è¯·å¯¹æ‰‹</button>
      <div class="info-text" id="roomInfo" style="display:none;"></div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div class="card-1win" id="gameSection" style="display:none;">
      <!-- VSå¡ç‰‡ -->
      <div class="vs-card">
        <div class="player-card">
          <div class="avatar-3d"></div>
          <div class="player-name" id="p1Name">ä½ </div>
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span id="p1Status">åœ¨çº¿</span>
          </div>
        </div>
        <div class="vs-divider">
          <div class="vs-text">VS</div>
          <div class="timer-display" id="timer">00:30</div>
        </div>
        <div class="player-card">
          <div class="avatar-3d opponent"></div>
          <div class="player-name" id="p2Name">ç­‰å¾…ä¸­...</div>
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span id="p2Status">ç­‰å¾…</span>
          </div>
        </div>
      </div>

      <!-- åˆ†æ•°æ˜¾ç¤º -->
      <div class="scores-grid">
        <div class="score-box" id="scoreBox1">
          <div class="score-label">ä½ çš„åˆ†æ•°</div>
          <div class="score-value" id="score1">0</div>
        </div>
        <div class="score-box" id="scoreBox2">
          <div class="score-label">å¯¹æ‰‹åˆ†æ•°</div>
          <div class="score-value" id="score2">0</div>
        </div>
      </div>

      <!-- ReadyçŠ¶æ€æ˜¾ç¤º -->
      <div id="readyStatusDisplay" style="display:none;">
        <div class="info-text" id="readyStatusText"></div>
      </div>

      <!-- ReadyæŒ‰é’® -->
      <div class="ready-section" id="readySection" style="display:none;">
        <button class="btn-1win btn-secondary" onclick="shareRoom()">é‚€è¯·å¥½å‹</button>
        <button class="btn-1win" id="readyBtn" onclick="setReady()">å‡†å¤‡å¼€å§‹</button>
      </div>

      <!-- ç‚¹å‡»åŒºåŸŸ -->
      <div class="tap-zone" id="tapZone" style="display:none;">
        <div class="tap-button-3d" id="tapBtn">
          <div class="tap-icon">âš¡</div>
          <div class="tap-text">ç–¯ç‹‚ç‚¹å‡»ï¼</div>
          <div class="tap-hint">30ç§’å†…ç‚¹å‡»æœ€å¤šè·èƒœ</div>
        </div>
      </div>

      <!-- ç»“æœæ˜¾ç¤º -->
      <div class="result-card" id="resultSection" style="display:none;">
        <div class="result-emoji" id="resultEmoji">ğŸ†</div>
        <div class="result-text" id="resultText"></div>
        <div class="result-details" id="resultDetails"></div>
        <button class="btn-1win" onclick="resetGame()" style="margin-top:20px;">å†æ¥ä¸€å±€</button>
      </div>
    </div>

    <!-- åŠ å…¥æˆ¿é—´åŒºåŸŸ -->
    <div class="card-1win" id="joinSection">
      <div class="card-title">ğŸšª åŠ å…¥ç°æœ‰æˆ¿é—´</div>
      <input class="input-1win" id="join_room_id" placeholder="è¾“å…¥æˆ¿é—´ID" />
      <button class="btn-1win btn-secondary" onclick="enterRoom()">è¿›å…¥æˆ¿é—´</button>
    </div>
  </div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  // è‡ªåŠ¨æ£€æµ‹APIåœ°å€ï¼šç”Ÿäº§ç¯å¢ƒç”¨å½“å‰åŸŸåï¼Œæœ¬åœ°ç”¨localhost
  const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? "http://127.0.0.1:8000"
    : window.location.origin;

  let currentRoomId = null;
  let currentRoom = null;
  let pollInterval = null;
  let gameTimer = null;
  let lastClickCount = 0;

  // åˆå§‹åŒ–Telegram WebApp
  if (window.Telegram?.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
  }

  // åˆ‡æ¢è°ƒè¯•é¢æ¿
  function toggleDebug() {
    const debug = document.getElementById('debugSection');
    debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
  }

  function getUser() {
    const user_id = parseInt(document.getElementById("uid").value || "0", 10);
    const username = document.getElementById("uname").value || null;
    if (!user_id) throw new Error("è¯·å…ˆå¡«å†™ user_id");
    return { user_id, username };
  }

  async function checkBalance() {
    try {
      const u = getUser();
      const r = await fetch(`${API}/api/users/${u.user_id}`);
      const data = await r.json();

      const balanceEl = document.getElementById("balance");
      const balanceInfoEl = document.getElementById("balanceInfo");

      if (r.ok) {
        balanceEl.textContent = data.available.toLocaleString();
        balanceInfoEl.textContent = `å¯ç”¨: ${data.available} | å†»ç»“: ${data.frozen}`;
        balanceInfoEl.style.display = 'block';
      } else {
        balanceEl.textContent = "1000";
        balanceInfoEl.textContent = "æœªæ‰¾åˆ°ç”¨æˆ·ï¼ˆåˆ›å»ºæˆ¿é—´ä¼šè‡ªåŠ¨åˆ›å»ºå¹¶å‘1000åˆå§‹åˆ†ï¼‰";
        balanceInfoEl.style.display = 'block';
      }
    } catch (e) {
      alert("æŸ¥è¯¢å¤±è´¥: " + e.message);
    }
  }

  async function createRoom() {
    try {
      const u = getUser();
      const bet_amount = parseInt(document.getElementById("bet").value || "0", 10);

      if (!bet_amount || bet_amount < 1 || bet_amount > 100000) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ¼æ³¨é‡‘é¢ (1-100000)");
        return;
      }

      const r = await fetch(`${API}/api/rooms`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user: u, bet_amount, chat_id: null })
      });

      const data = await r.json();
      if (!r.ok) {
        alert("åˆ›å»ºå¤±è´¥ï¼š" + (data.detail || JSON.stringify(data)));
        return;
      }

      currentRoomId = data.room_id;

      // æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
      const roomInfoEl = document.getElementById("roomInfo");
      roomInfoEl.innerHTML = `
        âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸï¼<br>
        æˆ¿é—´ID: <strong>${data.room_id}</strong><br>
        æŠ¼æ³¨: <strong>${data.bet_amount} LGW33</strong>
      `;
      roomInfoEl.style.display = 'block';

      // è‡ªåŠ¨åˆ†äº«åˆ°ç¾¤
      await shareRoom();

      // åˆ‡æ¢åˆ°æ¸¸æˆç•Œé¢
      await enterRoom(data.room_id);

      await checkBalance();
    } catch (e) {
      alert("åˆ›å»ºæˆ¿é—´å¤±è´¥: " + e.message);
    }
  }

  async function shareRoom() {
    if (!currentRoomId) {
      alert("è¯·å…ˆåˆ›å»ºæˆ¿é—´");
      return;
    }

    try {
      const u = getUser();
      const r = await fetch(`${API}/api/rooms/${currentRoomId}/share`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user: u })
      });

      const data = await r.json();
      if (r.ok) {
        // ä½¿ç”¨Telegram WebAppåˆ†äº«åŠŸèƒ½ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.showAlert("é‚€è¯·å·²å‘é€åˆ°æ¸¸æˆç¾¤ï¼");
        }
      } else {
        alert("åˆ†äº«å¤±è´¥ï¼š" + (data.detail || JSON.stringify(data)));
      }
    } catch (e) {
      console.error("åˆ†äº«å¤±è´¥:", e);
    }
  }

  // è¿›å…¥æˆ¿é—´
  async function enterRoom(roomId) {
    const room_id = roomId || document.getElementById("join_room_id").value.trim();
    if (!room_id) {
      alert("è¯·è¾“å…¥æˆ¿é—´ID");
      return;
    }

    currentRoomId = room_id;

    // éšè—åˆ›å»ºå’ŒåŠ å…¥åŒºåŸŸï¼Œæ˜¾ç¤ºæ¸¸æˆåŒºåŸŸ
    document.getElementById("createSection").style.display = "none";
    document.getElementById("joinSection").style.display = "none";
    document.getElementById("gameSection").style.display = "block";

    await updateRoomStatus();

    // å¼€å§‹è½®è¯¢æˆ¿é—´çŠ¶æ€
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(updateRoomStatus, 1000);
  }

  // æ›´æ–°æˆ¿é—´çŠ¶æ€
  async function updateRoomStatus() {
    if (!currentRoomId) return;

    try {
      const r = await fetch(`${API}/api/rooms/${currentRoomId}`);
      if (!r.ok) {
        alert("æˆ¿é—´ä¸å­˜åœ¨");
        return;
      }

      currentRoom = await r.json();
      const u = getUser();
      const isHost = currentRoom.host_id === u.user_id;
      const isGuest = currentRoom.guest_id === u.user_id;

      // æ›´æ–°ç©å®¶ä¿¡æ¯
      document.getElementById("p1Name").textContent = isHost ? "ä½ " : `@${currentRoom.host_username}`;
      document.getElementById("p2Name").textContent = currentRoom.guest_username
        ? (isGuest ? "ä½ " : `@${currentRoom.guest_username}`)
        : "ç­‰å¾…ä¸­...";

      // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒç•Œé¢
      if (currentRoom.status === 'OPEN') {
        // ç­‰å¾…å¯¹æ‰‹åŠ å…¥
        document.getElementById("readySection").style.display = "none";
        document.getElementById("tapZone").style.display = "none";
        document.getElementById("resultSection").style.display = "none";
        document.getElementById("readyStatusDisplay").style.display = "block";
        document.getElementById("readyStatusText").textContent = "ç­‰å¾…å¯¹æ‰‹åŠ å…¥æˆ¿é—´...";

      } else if (currentRoom.status === 'FULL') {
        // æ˜¾ç¤ºReadyç•Œé¢
        document.getElementById("readySection").style.display = "flex";
        document.getElementById("tapZone").style.display = "none";
        document.getElementById("resultSection").style.display = "none";
        document.getElementById("readyStatusDisplay").style.display = "block";

        const hostReady = currentRoom.host_ready === 1;
        const guestReady = currentRoom.guest_ready === 1;

        document.getElementById("readyStatusText").innerHTML =
          `æˆ¿ä¸»: ${hostReady ? 'âœ… Ready' : 'â³ æœªReady'}<br>` +
          `å®¢äºº: ${guestReady ? 'âœ… Ready' : 'â³ æœªReady'}`;

        // å¦‚æœå½“å‰ç”¨æˆ·å·²Readyï¼Œç¦ç”¨æŒ‰é’®
        const myReady = (isHost && hostReady) || (isGuest && guestReady);
        document.getElementById("readyBtn").disabled = myReady;
        document.getElementById("readyBtn").textContent = myReady ? "å·²å‡†å¤‡ âœ…" : "å‡†å¤‡å¼€å§‹";

        document.getElementById("p1Status").textContent = hostReady ? "Ready" : "ç­‰å¾…";
        document.getElementById("p2Status").textContent = guestReady ? "Ready" : "ç­‰å¾…";

      } else if (currentRoom.status === 'PLAYING') {
        // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
        document.getElementById("readySection").style.display = "none";
        document.getElementById("readyStatusDisplay").style.display = "none";
        document.getElementById("tapZone").style.display = "flex";
        document.getElementById("resultSection").style.display = "none";

        // æ›´æ–°ç‚¹å‡»æ•°
        const myClicks = isHost ? currentRoom.host_clicks : currentRoom.guest_clicks;
        const opponentClicks = isHost ? currentRoom.guest_clicks : currentRoom.host_clicks;

        document.getElementById("score1").textContent = myClicks;
        document.getElementById("score2").textContent = opponentClicks;

        // é«˜äº®é¢†å…ˆæ–¹
        const scoreBox1 = document.getElementById("scoreBox1");
        const scoreBox2 = document.getElementById("scoreBox2");
        scoreBox1.classList.toggle('winning', myClicks > opponentClicks);
        scoreBox2.classList.toggle('winning', opponentClicks > myClicks);

        // åˆ†æ•°å˜åŒ–åŠ¨ç”»
        if (myClicks > lastClickCount) {
          document.getElementById("score1").classList.add('pulse');
          setTimeout(() => document.getElementById("score1").classList.remove('pulse'), 300);
        }
        lastClickCount = myClicks;

        // æ›´æ–°å€’è®¡æ—¶
        if (currentRoom.game_start_time) {
          const startTime = new Date(currentRoom.game_start_time + 'Z');
          const elapsed = (Date.now() - startTime.getTime()) / 1000;
          const remaining = Math.max(0, Math.ceil(30 - elapsed));

          const mins = Math.floor(remaining / 60);
          const secs = remaining % 60;
          document.getElementById("timer").textContent =
            `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

          // å¦‚æœæ—¶é—´åˆ°äº†ï¼Œè‡ªåŠ¨ç»“ç®—
          if (remaining === 0) {
            await settleGame();
          }
        }

      } else if (currentRoom.status === 'FINISHED') {
        // æ˜¾ç¤ºç»“æœç•Œé¢
        document.getElementById("readySection").style.display = "none";
        document.getElementById("readyStatusDisplay").style.display = "none";
        document.getElementById("tapZone").style.display = "none";
        document.getElementById("resultSection").style.display = "block";

        const winnerId = currentRoom.winner_id;
        const myClicks = isHost ? currentRoom.host_clicks : currentRoom.guest_clicks;
        const opponentClicks = isHost ? currentRoom.guest_clicks : currentRoom.host_clicks;

        if (winnerId === null) {
          document.getElementById("resultEmoji").textContent = "ğŸ¤";
          document.getElementById("resultText").textContent = "å¹³å±€ï¼";
          document.getElementById("resultDetails").innerHTML =
            `åŒæ–¹é€€å›æŠ¼æ³¨<br><br>` +
            `ä½ çš„ç‚¹å‡»: ${myClicks} æ¬¡<br>` +
            `å¯¹æ‰‹ç‚¹å‡»: ${opponentClicks} æ¬¡`;
        } else if (winnerId === u.user_id) {
          document.getElementById("resultEmoji").textContent = "ğŸ‰";
          document.getElementById("resultText").textContent = "ä½ èµ¢äº†ï¼";
          document.getElementById("resultDetails").innerHTML =
            `è·å¾— ${currentRoom.bet_amount * 2} LGW33<br><br>` +
            `ä½ çš„ç‚¹å‡»: ${myClicks} æ¬¡<br>` +
            `å¯¹æ‰‹ç‚¹å‡»: ${opponentClicks} æ¬¡`;
        } else {
          document.getElementById("resultEmoji").textContent = "ğŸ˜¢";
          document.getElementById("resultText").textContent = "ä½ è¾“äº†";
          document.getElementById("resultDetails").innerHTML =
            `å¤±å» ${currentRoom.bet_amount} LGW33<br><br>` +
            `ä½ çš„ç‚¹å‡»: ${myClicks} æ¬¡<br>` +
            `å¯¹æ‰‹ç‚¹å‡»: ${opponentClicks} æ¬¡`;
        }

        // åœæ­¢è½®è¯¢
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }

        // æ›´æ–°ä½™é¢
        await checkBalance();
      }

    } catch (e) {
      console.error("æ›´æ–°æˆ¿é—´çŠ¶æ€å¤±è´¥:", e);
    }
  }

  // ç‚¹å‡»Ready
  async function setReady() {
    if (!currentRoomId) return;

    try {
      const u = getUser();
      const r = await fetch(`${API}/api/rooms/${currentRoomId}/ready`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user: u })
      });

      if (r.ok) {
        const data = await r.json();
        if (data.both_ready) {
          // åŒæ–¹éƒ½Readyï¼Œæ¸¸æˆå³å°†å¼€å§‹
          if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
          }
        }
        await updateRoomStatus();
      } else {
        alert("Readyå¤±è´¥");
      }
    } catch (e) {
      alert("Readyå¤±è´¥: " + e.message);
    }
  }

  // ç‚¹å‡»æ¸¸æˆæŒ‰é’®
  async function clickGame(event) {
    if (!currentRoomId || !currentRoom || currentRoom.status !== 'PLAYING') return;

    try {
      const u = getUser();
      const r = await fetch(`${API}/api/rooms/${currentRoomId}/click`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user: u })
      });

      if (r.ok) {
        const data = await r.json();
        const isHost = currentRoom.host_id === u.user_id;

        // ç«‹å³æ›´æ–°æ˜¾ç¤º
        const myClicks = isHost ? data.host_clicks : data.guest_clicks;
        document.getElementById("score1").textContent = myClicks;

        // æµ®åŠ¨åˆ†æ•°æ•ˆæœ
        if (event) {
          const rect = document.getElementById("tapZone").getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;
          showFloatingScore(x, y);
        }

        // Telegramè§¦è§‰åé¦ˆ
        if (window.Telegram?.WebApp?.HapticFeedback) {
          window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
      }
    } catch (e) {
      console.error("ç‚¹å‡»å¤±è´¥:", e);
    }
  }

  // æµ®åŠ¨åˆ†æ•°æ•ˆæœ
  function showFloatingScore(x, y) {
    const float = document.createElement('div');
    float.className = 'float-score';
    float.textContent = '+1';
    float.style.left = x + 'px';
    float.style.top = y + 'px';
    document.getElementById('tapZone').appendChild(float);
    setTimeout(() => float.remove(), 800);
  }

  // ç»“ç®—æ¸¸æˆ
  async function settleGame() {
    if (!currentRoomId) return;

    try {
      const u = getUser();
      const r = await fetch(`${API}/api/rooms/${currentRoomId}/settle`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(u)
      });

      if (r.ok) {
        await updateRoomStatus();
      }
    } catch (e) {
      console.error("ç»“ç®—å¤±è´¥:", e);
    }
  }

  // é‡ç½®æ¸¸æˆ
  function resetGame() {
    currentRoomId = null;
    currentRoom = null;
    lastClickCount = 0;

    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
    }

    document.getElementById("createSection").style.display = "block";
    document.getElementById("joinSection").style.display = "block";
    document.getElementById("gameSection").style.display = "none";
    document.getElementById("roomInfo").style.display = "none";

    // æ¸…ç©ºè¾“å…¥
    document.getElementById("bet").value = "";
    document.getElementById("join_room_id").value = "";
  }

  // ç»‘å®šç‚¹å‡»äº‹ä»¶
  document.addEventListener('DOMContentLoaded', () => {
    const tapBtn = document.getElementById('tapBtn');
    if (tapBtn) {
      tapBtn.addEventListener('pointerdown', clickGame);
    }

    // åˆå§‹åŒ–Telegram WebApp
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }

    // è‡ªåŠ¨å¡«å……è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘ç”¨ï¼‰
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      document.getElementById('debugSection').style.display = 'block';
      document.getElementById('uid').value = '12345';
      document.getElementById('uname').value = 'player1';
    }
  });
</script>
</body>
</html>
