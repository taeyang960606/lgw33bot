<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PK Tap Battle - Mini App UI Demo</title>
  <style>
    :root{
      --bg:#070A12;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --brand:#24D6FF;
      --good:#30ff9b;
      --warn:#ffcc00;
      --bad:#ff4d6d;

      --radius: 18px;
      --shadow: 0 16px 48px rgba(0,0,0,.5);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(36,214,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 100% 25%, rgba(255,77,109,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", Arial, sans-serif;
      overflow:hidden;
    }

    /* Safe area padding for iOS notch */
    .safe{
      padding: calc(env(safe-area-inset-top) + 14px) 14px calc(env(safe-area-inset-bottom) + 14px);
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      max-width:520px;
      margin:0 auto;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--good);
      box-shadow: 0 0 16px rgba(48,255,155,.55);
    }
    .btn-ghost{
      appearance:none;border:1px solid var(--line);
      background:transparent;color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-ghost:active{ transform: scale(.98); }

    .arena{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    .scorecard{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .players{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:10px;
      align-items:center;
    }

    .player{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .avatar{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(36,214,255,.45), rgba(255,77,109,.25));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 36px rgba(0,0,0,.35);
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .avatar::after{
      content:"";
      position:absolute;inset:-20px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 40%);
      transform: rotate(20deg);
    }
    .meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .name{
      font-weight:800;
      font-size:14px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .tag{
      font-size:12px;color:var(--muted);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }

    .vs{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .vs b{
      letter-spacing:1px;
      font-size:12px;
      color:rgba(255,255,255,.75);
    }
    .timer{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      font-size:16px;
      color:var(--warn);
      text-shadow: 0 0 18px rgba(255,204,0,.3);
    }

    .scores{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .scoreBox{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px 12px;
      background: rgba(255,255,255,.04);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .scoreBox.lead{
      border-color: rgba(48,255,155,.35);
      box-shadow: 0 0 0 1px rgba(48,255,155,.12), 0 20px 45px rgba(48,255,155,.10);
    }
    .scoreLabel{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .spark{
      width:8px;height:8px;border-radius:999px;
      background: var(--brand);
      box-shadow: 0 0 16px rgba(36,214,255,.55);
    }
    .scoreNum{
      font-variant-numeric: tabular-nums;
      font-weight:950;
      font-size:26px;
      letter-spacing:.3px;
    }
    .scoreNum.pulse{
      animation: pop .18s ease-out;
    }
    @keyframes pop{
      from{ transform: scale(.92); filter: brightness(1.3); }
      to{ transform: scale(1); filter: brightness(1); }
    }

    .tapArea{
      flex:1;
      min-height:0;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      padding:16px;
    }

    /* Big tap button */
    .tapBtn{
      width:min(320px, 86vw);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 40%),
        radial-gradient(circle at 50% 60%, rgba(36,214,255,.22), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow:
        0 24px 90px rgba(0,0,0,.55),
        inset 0 0 0 1px rgba(36,214,255,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transform: translateZ(0);
      transition: transform .06s ease;
    }
    .tapBtn::before{
      content:"";
      position:absolute; inset:-10px;
      border-radius:999px;
      background: radial-gradient(circle, rgba(36,214,255,.25), transparent 60%);
      filter: blur(2px);
      opacity:.75;
      animation: breathe 1.9s ease-in-out infinite;
    }
    @keyframes breathe{
      0%,100%{ transform: scale(.98); opacity:.55; }
      50%{ transform: scale(1.02); opacity:.9; }
    }
    .tapBtn:active{ transform: scale(.985); }

    .tapCenter{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      text-align:center;
      position:relative;
      z-index:1;
      padding:18px;
    }
    .tapTitle{
      font-weight:950;
      font-size:18px;
      letter-spacing:.3px;
    }
    .tapHint{
      font-size:12px;
      color:var(--muted);
    }
    .tapSub{
      margin-top:6px;
      font-size:12px;
      color:rgba(255,255,255,.75);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
    }

    /* Floating +score */
    .float{
      position:absolute;
      font-weight:900;
      font-variant-numeric: tabular-nums;
      pointer-events:none;
      animation: floatUp .55s ease-out forwards;
      text-shadow: 0 10px 28px rgba(0,0,0,.55);
    }
    @keyframes floatUp{
      from{ transform: translate(-50%, 0) scale(.95); opacity:0; }
      15%{ opacity:1; }
      to{ transform: translate(-50%, -58px) scale(1.05); opacity:0; }
    }

    /* Bottom HUD */
    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .hudCard{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .hudRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .hudValue{
      font-weight:900;
      color:rgba(255,255,255,.88);
      font-variant-numeric: tabular-nums;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width:40%;
      background: linear-gradient(90deg, rgba(36,214,255,.85), rgba(48,255,155,.85));
      border-radius:999px;
      box-shadow: 0 0 18px rgba(36,214,255,.25);
    }

    .footerActions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:var(--text);
      border-radius: 14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      flex:1;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
    }
    .btn.primary{
      border-color: rgba(36,214,255,.30);
      box-shadow: 0 0 0 1px rgba(36,214,255,.12), 0 18px 55px rgba(36,214,255,.15);
    }
    .btn:active{ transform: scale(.99); }

    /* Subtle scanline */
    .scan{
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03),
        rgba(255,255,255,.03) 1px,
        transparent 1px,
        transparent 7px
      );
      opacity:.12;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
  </style>
</head>

<body>
  <div class="safe">
    <!-- Top bar -->
    <div class="topbar">
      <div class="chip" title="Room status">
        <span class="dot" id="liveDot"></span>
        <span id="roomText">Room #A1B2 • LIVE</span>
      </div>
      <button class="btn-ghost" id="leaveBtn">退出</button>
    </div>

    <div class="arena">
      <!-- Score Card -->
      <div class="scorecard">
        <div class="players">
          <div class="player">
            <div class="avatar" aria-hidden="true"></div>
            <div class="meta">
              <div class="name" id="p1Name">你（@you）</div>
              <div class="tag" id="p1Tag">Rank: Bronze • Stake: 100</div>
            </div>
          </div>

          <div class="vs">
            <b>VS</b>
            <div class="timer" id="timer">00:30</div>
          </div>

          <div class="player" style="justify-content:flex-end;">
            <div class="meta" style="text-align:right;">
              <div class="name" id="p2Name">@opponent</div>
              <div class="tag" id="p2Tag">Online • Ping 48ms</div>
            </div>
            <div class="avatar" aria-hidden="true" style="background:linear-gradient(135deg, rgba(255,77,109,.40), rgba(36,214,255,.18));"></div>
          </div>
        </div>

        <div class="scores">
          <div class="scoreBox" id="boxP1">
            <div class="scoreLabel"><span class="spark"></span> 你的分数</div>
            <div class="scoreNum" id="scoreP1">0</div>
          </div>
          <div class="scoreBox" id="boxP2">
            <div class="scoreLabel"><span class="spark" style="background:var(--bad); box-shadow:0 0 16px rgba(255,77,109,.55);"></span> 对手分数</div>
            <div class="scoreNum" id="scoreP2">0</div>
          </div>
        </div>
      </div>

      <!-- Tap Area -->
      <div class="tapArea" id="tapArea">
        <div class="scan"></div>

        <div class="tapBtn" id="tapBtn" role="button" aria-label="Tap button">
          <div class="tapCenter">
            <div class="tapTitle">点！点！点！</div>
            <div class="tapHint">30 秒内分数最高获胜</div>
            <div class="tapSub" id="comboText">Combo x0</div>
          </div>
        </div>
      </div>

      <!-- HUD -->
      <div class="hud">
        <div class="hudCard">
          <div class="hudRow">
            <span>连击</span>
            <span class="hudValue" id="comboVal">0</span>
          </div>
          <div class="hudRow">
            <span>暴击状态</span>
            <span class="hudValue" id="critState">READY</span>
          </div>
        </div>
        <div class="hudCard">
          <div class="hudRow">
            <span>能量</span>
            <span class="hudValue" id="energyVal">40%</span>
          </div>
          <div class="bar" aria-hidden="true"><i id="energyBar"></i></div>
        </div>
      </div>

      <!-- Footer actions -->
      <div class="footerActions">
        <button class="btn" id="inviteBtn">邀请对战</button>
        <button class="btn primary" id="readyBtn">准备 / 开始</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // UI-only Demo Logic (no backend)
    // ==========================
    const scoreP1El = document.getElementById('scoreP1');
    const scoreP2El = document.getElementById('scoreP2');
    const boxP1 = document.getElementById('boxP1');
    const boxP2 = document.getElementById('boxP2');

    const tapBtn = document.getElementById('tapBtn');
    const tapArea = document.getElementById('tapArea');

    const comboText = document.getElementById('comboText');
    const comboVal = document.getElementById('comboVal');
    const critState = document.getElementById('critState');

    const timerEl = document.getElementById('timer');
    const energyVal = document.getElementById('energyVal');
    const energyBar = document.getElementById('energyBar');

    let scoreP1 = 0;
    let scoreP2 = 0;

    let combo = 0;
    let energy = 0.4; // 0..1
    let critReady = true;

    let playing = false;
    let remain = 30;
    let tick = null;

    function setLeadUI(){
      boxP1.classList.toggle('lead', scoreP1 > scoreP2);
      boxP2.classList.toggle('lead', scoreP2 > scoreP1);
    }

    function pulse(el){
      el.classList.remove('pulse');
      // force reflow
      void el.offsetWidth;
      el.classList.add('pulse');
    }

    function spawnFloat(text, x, y, good=true){
      const div = document.createElement('div');
      div.className = 'float';
      div.textContent = text;
      div.style.left = x + 'px';
      div.style.top = y + 'px';
      div.style.color = good ? 'rgba(48,255,155,.95)' : 'rgba(255,77,109,.95)';
      div.style.fontSize = good ? '18px' : '16px';
      tapArea.appendChild(div);
      setTimeout(()=>div.remove(), 600);
    }

    function updateHUD(){
      comboText.textContent = `Combo x${combo}`;
      comboVal.textContent = combo;

      energyVal.textContent = Math.round(energy*100) + '%';
      energyBar.style.width = Math.max(0, Math.min(100, energy*100)) + '%';

      critState.textContent = critReady ? 'READY' : 'COOLDOWN';
      critState.style.color = critReady ? 'rgba(255,255,255,.88)' : 'rgba(255,204,0,.92)';
    }

    function formatTime(sec){
      const m = String(Math.floor(sec / 60)).padStart(2,'0');
      const s = String(sec % 60).padStart(2,'0');
      return `${m}:${s}`;
    }

    function start(){
      if (playing) return;
      playing = true;
      remain = 30;
      timerEl.textContent = formatTime(remain);

      tick = setInterval(()=>{
        remain--;
        timerEl.textContent = formatTime(remain);
        if (remain <= 0){
          stop();
          showResult();
        }

        // demo: opponent slowly increases
        if (playing){
          scoreP2 += Math.random() < 0.55 ? 1 : 0;
          scoreP2El.textContent = scoreP2;
          setLeadUI();
        }
      }, 1000);
    }

    function stop(){
      playing = false;
      clearInterval(tick);
      tick = null;
    }

    function showResult(){
      const win = scoreP1 > scoreP2;
      const msg = win ? `你赢了！\n${scoreP1} : ${scoreP2}` : (scoreP1 === scoreP2 ? `平局！\n${scoreP1} : ${scoreP2}` : `你输了…\n${scoreP1} : ${scoreP2}`);
      alert(msg);
    }

    // Tap interaction
    tapBtn.addEventListener('pointerdown', (e)=>{
      if (!playing) return;

      // Combo & energy build
      combo++;
      energy = Math.min(1, energy + 0.03);

      let add = 1;

      // Crit: every 6 combo if ready -> +3
      if (combo % 6 === 0 && critReady){
        add = 3;
        critReady = false;
        setTimeout(()=>{ critReady = true; updateHUD(); }, 1200);
      }

      scoreP1 += add;
      scoreP1El.textContent = scoreP1;
      pulse(scoreP1El);

      setLeadUI();
      updateHUD();

      // Visual feedback: floating +score at tap location
      const rect = tapArea.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      spawnFloat(`+${add}`, x, y, true);

      // Light haptic on supported devices (optional)
      // if (window.Telegram?.WebApp?.HapticFeedback) {
      //   window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
      // }
    });

    // Buttons
    document.getElementById('readyBtn').addEventListener('click', ()=>{
      // simple reset for demo
      scoreP1 = 0; scoreP2 = 0; combo = 0; energy = 0.4; critReady = true;
      scoreP1El.textContent = scoreP1;
      scoreP2El.textContent = scoreP2;
      setLeadUI();
      updateHUD();
      start();
    });

    document.getElementById('inviteBtn').addEventListener('click', ()=>{
      // Placeholder: in Telegram you would use share link / startapp param
      alert('这里放“分享邀请卡片/链接”的逻辑（Telegram startapp 参数）');
    });

    document.getElementById('leaveBtn').addEventListener('click', ()=>{
      stop();
      alert('退出房间（这里接你的路由/关闭 WebApp）');
    });

    // Init
    timerEl.textContent = formatTime(remain);
    setLeadUI();
    updateHUD();
  </script>
</body>
</html>
