# LGW33 PK游戏 - 使用指南

## 🎮 游戏简介

LGW33 PK是一个基于Telegram的实时点击对战游戏。两名玩家在30秒内疯狂点击，点击次数多的玩家获胜并赢得全部押注！

## 🚀 快速开始

### 1. 数据库迁移

如果你已经有旧的数据库，需要先运行迁移脚本：

```bash
python migrate_db.py
```

如果是全新安装，可以直接删除旧数据库：

```bash
del lgw33.db  # Windows
rm lgw33.db   # Linux/Mac
```

### 2. 启动服务

**启动API服务**（终端1）：
```bash
run_api.bat
```

**启动Bot服务**（终端2）：
```bash
run_bot.bat
```

### 3. 初始化用户

在Telegram中找到你的Bot，发送：
```
/start
```

Bot会自动为你创建账户并分配1000 LGW33初始余额。

## 📖 游戏流程

### 步骤1：创建房间

1. 打开MiniApp: http://127.0.0.1:8000
2. 填写你的user_id和username（与Telegram一致）
3. 设置押注金额（例如：100）
4. 点击"创建房间"
5. 记下房间ID

### 步骤2：分享邀请

1. 获取群组chat_id（在群里发送`/chatid`给Bot）
2. 在MiniApp中填写群chat_id
3. 点击"分享邀请到群"
4. Bot会在群里发送邀请卡片

### 步骤3：加入房间

1. 其他玩家点击群里的"加入房间挑战"按钮
2. Bot会自动处理加入逻辑
3. 房间状态变为FULL

### 步骤4：Ready准备

1. 双方玩家在MiniApp中输入房间ID
2. 点击"进入房间"
3. 看到Ready按钮后，点击"我已准备"
4. 等待对方也点击Ready

### 步骤5：开始游戏

1. 双方都Ready后，游戏自动开始
2. 30秒倒计时开始
3. 疯狂点击"🔥 点击！"按钮
4. 实时查看双方点击数

### 步骤6：查看结果

1. 30秒后游戏自动结算
2. MiniApp显示游戏结果
3. Bot在群里播报结果
4. 获胜者获得双方押注总额

## 🎯 游戏规则

- **游戏时长**：30秒
- **胜利条件**：点击次数多的玩家获胜
- **奖励**：获胜者获得双方押注总额（例如：双方各押100，获胜者得200）
- **平局**：点击数相同时，双方退回押注
- **押注范围**：1-100000 LGW33

## 🧪 测试功能

运行自动化测试脚本：

```bash
python test_game.py
```

这个脚本会：
1. 创建测试房间
2. 模拟两个玩家加入
3. 双方Ready
4. 模拟点击
5. 自动结算
6. 检查余额变化

## 📊 房间状态说明

| 状态 | 说明 | 下一步 |
|------|------|--------|
| OPEN | 等待玩家加入 | 其他玩家点击加入 |
| FULL | 双方已加入 | 双方点击Ready |
| PLAYING | 游戏进行中 | 疯狂点击 |
| FINISHED | 游戏已结束 | 查看结果 |
| CANCELLED | 已取消 | - |

## 🔧 常见问题

### Q: 如何获取群组chat_id？
A: 在群里发送`/chatid`给Bot，Bot会回复群组ID。

### Q: Ready后多久开始游戏？
A: 双方都Ready后立即开始，无需等待。

### Q: 游戏中途可以退出吗？
A: 不可以，押注已冻结，必须等游戏结束。

### Q: 平局怎么办？
A: 双方退回各自的押注，无人获利。

### Q: 可以自己和自己玩吗？
A: 不可以，房主不能加入自己的房间。

### Q: 余额不足怎么办？
A: 目前只能通过`/start`获得初始余额，后续可以添加充值功能。

## 📝 开发说明

### 新增API接口

- `POST /api/internal/init_user` - 初始化用户
- `GET /api/rooms/{room_id}` - 获取房间状态
- `POST /api/rooms/{room_id}/ready` - 玩家Ready
- `POST /api/rooms/{room_id}/click` - 记录点击
- `POST /api/rooms/{room_id}/settle` - 结算游戏

### 新增数据库字段

rooms表新增字段：
- `host_ready` - 房主Ready状态
- `guest_ready` - 客人Ready状态
- `host_clicks` - 房主点击数
- `guest_clicks` - 客人点击数
- `game_start_time` - 游戏开始时间
- `game_end_time` - 游戏结束时间
- `winner_id` - 获胜者ID

### 新增Bot命令

- `/start` - 初始化用户账户

## 🎨 界面预览

MiniApp包含4个主要部分：
1. **用户信息** - 查询余额
2. **创建房间** - 设置押注并创建
3. **分享邀请** - 发送到群聊
4. **游戏界面** - Ready、点击、结果

## 📞 技术支持

如有问题，请查看：
- `GAME_FEATURES.md` - 详细功能说明
- `check_db.py` - 检查数据库状态
- `test_game.py` - 自动化测试

祝游戏愉快！🎉

